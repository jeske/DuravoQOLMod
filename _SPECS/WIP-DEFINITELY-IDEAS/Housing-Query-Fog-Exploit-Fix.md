> **Status: ðŸ“‹ INCOMPLETE SPEC - BRAINSTORMING**
>
> Design phase. No implementation yet.

---

## Housing Query Fog-of-War Exploit Fix

### Problem

The housing query tool (`?` button in housing UI) allows players to click anywhere on the map and receive detailed feedback about tile composition - even in unexplored areas hidden by fog-of-war.

This leaks information that should require physical exploration:

- "This housing is missing a light source" â†’ reveals there's a structure with walls, furniture, but no torch
- "This is not valid housing" â†’ reveals there's solid tile or empty space
- "This housing is suitable" â†’ reveals a complete NPC-ready room exists (natural cabin, dungeon room, etc.)

Players can systematically probe the map to locate underground cabins, dungeon rooms, and pre-built structures without ever exploring. This is particularly egregious because:

1. **Underground cabins** contain chests with valuable early-game loot
2. **Dungeon rooms** can be mapped before fighting Skeletron
3. **Pyramids/temples** can be located from surface without digging

### The Vanilla Mechanism

Housing validation flows through `WorldGen.StartRoomCheck(int x, int y)` which:

1. Reads `Main.tile[x, y]` directly (world data, always present)
2. Performs flood-fill to find room boundaries via `WorldGen.CheckRoom()`
3. Validates furniture requirements via `WorldGen.RoomNeeds()`
4. Returns result string to UI

The fog-of-war (exploration state) is stored separately in `Main.Map` which is per-player data saved in the player's folder - NOT the world file. The housing check never consults this.

```
World Data (Tiles)     Player Data (Map)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Main.tile[x,y]  â”‚    â”‚ Main.Map[x,y]   â”‚
â”‚ Always present  â”‚    â”‚ Explored state  â”‚
â”‚ Authoritative   â”‚    â”‚ Per-character   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†‘                      âœ—
        â”‚                 (not checked)
        â”‚
  Housing Query
```

### Solution

Intercept housing query clicks and validate exploration state BEFORE allowing vanilla logic to execute.

### Implementation Approach

**Option A: IL Hook on WorldGen.StartRoomCheck**

Patch the entry point to check exploration state first:

```csharp
public class HousingQueryFix : ModSystem {
    public override void Load() {
        On_WorldGen.StartRoomCheck += HousingQueryFix_StartRoomCheck;
    }

    private static bool HousingQueryFix_StartRoomCheck(
        On_WorldGen.orig_StartRoomCheck orig,
        int x, int y
    ) {
        // Check if target tile has been explored by this player
        if (!IsTileExplored(x, y)) {
            // Display generic fog message, reveal nothing
            Main.NewText("Cannot query unexplored area", Color.Gray);
            return false;
        }
        
        return orig(x, y);
    }

    private static bool IsTileExplored(int x, int y) {
        // Main.Map stores exploration state
        // MapTile.Light > 0 indicates the tile has been seen
        if (x < 0 || x >= Main.maxTilesX || y < 0 || y >= Main.maxTilesY)
            return false;
            
        return Main.Map[x, y].Light > 0;
    }
}
```

**Option B: UI Layer Intercept**

Hook the housing menu click handler before it dispatches to WorldGen:

```csharp
public class HousingUIFix : ModSystem {
    public override void Load() {
        // Hook into Main.DrawInterface or housing UI specifically
        On_Main.DrawInterface_40_InteractItemIcon += InterceptHousingQuery;
    }
    
    // Intercept at UI layer before query reaches WorldGen
}
```

**Option C: Detour Player.TileInteractAttempt**

May be cleaner if housing query routes through player interaction system.

### Exploration State Details

The `Main.Map` is a `MapTile[,]` array where:

- `MapTile.Light` (byte): 0 = unexplored, >0 = explored with that brightness
- `MapTile.Type` (ushort): Cached tile type at time of exploration
- `MapTile.Color` (byte): Paint/color overlay

The map updates in `Main.DrawToMap()` which runs during normal gameplay rendering. Tiles become "explored" when:

1. Player is within lighting range
2. A light source illuminates the tile
3. Map-revealing effects (e.g., some mods, ghost mode)

### Edge Cases

| Scenario | Behavior |
|----------|----------|
| Click in fog, drag to explored | Should fail (initial click in fog) |
| Partially explored room | Allow query if click tile explored, even if room extends into fog |
| Multiplayer: other player explored | Each player has own map state - use clicking player's state |
| Smart cursor housing query | Same rules apply - check cursor target tile |
| NPC flag placement in fog | Should also be blocked (same exploit vector) |

### The "Partial Room" Question

If a player has explored the left half of a valid room but not the right half, should the query work?

**Conservative approach (recommended):** Query succeeds if the clicked tile is explored. The flood-fill may extend into unexplored areas, but that's acceptable - player knows *something* is there, they just can't see it all.

**Strict approach:** Require entire detected room to be explored. This is harder to implement and may be frustrating (query fails with no clear reason).

### Message Design

When query blocked due to fog:

```
"You cannot see this area" 
```

NOT:
- "This area is unexplored" (too meta)
- "No valid housing found" (leaks info - confirms something IS there)
- "Cannot query unexplored housing" (implies there IS housing to query)

The message should be maximally uninformative.

### NPC Flag Placement

Same exploit applies to NPC assignment flags. If you can assign an NPC to an unexplored room, you've confirmed:

1. A valid room exists at that location
2. It has all required furniture
3. It's large enough for NPCs

**Fix:** Block NPC flag placement in fog using same exploration check.

```csharp
// Also hook WorldGen.MoveTownNPC or wherever flag placement is validated
```

### Testing Scenarios

**Housing Query:**

- [ ] Query explored valid room â†’ shows "suitable" (normal behavior)
- [ ] Query explored invalid room â†’ shows specific failure (normal behavior)
- [ ] Query unexplored area (any tile type) â†’ shows fog message, no info leak
- [ ] Query boundary (explored/unexplored) â†’ uses clicked tile state
- [ ] Query natural cabin in fog â†’ blocked, doesn't reveal cabin exists
- [ ] Query dungeon room in fog â†’ blocked

**NPC Assignment:**

- [ ] Assign NPC to explored valid room â†’ works
- [ ] Assign NPC to unexplored valid room â†’ blocked
- [ ] Assign NPC, then fog resets (new character) â†’ NPC stays, but reassignment blocked

**Multiplayer:**

- [ ] Host has explored, client hasn't â†’ client query blocked
- [ ] Client has explored, host hasn't â†’ client query works (uses client's map)

### Performance Considerations

`Main.Map[x, y].Light` is a simple array lookup - negligible cost. The check happens once per click, not per frame.

### Synergy with Other Features

| Feature | Synergy |
|---------|---------|
| LOS Block Interaction | Similar philosophy - can't interact with what you can't see |
| Persistent Position | Explored state persists across sessions, consistent with position |
| Depth-Scaled Difficulty | Natural cabins at depth become valuable - worth protecting from cheese |

### Mod Compatibility

**Potential conflicts:**

- **Hero's Mod** (map reveal): If player uses external map reveal, exploration state updates, our check passes. This is fine - they're already cheating.
- **Journey Mode**: Research mode may have map reveal. Check if `Main.Map` is updated or if it's a render-only reveal.
- **Multiplayer map sharing mods**: Some mods sync map exploration across players. This would affect our check per-player state assumption.

### Open Questions

1. **Journey Mode integration**: Does Journey's "reveal map" actually update `Main.Map` or just render differently?
2. **Hook stability**: Is `On_WorldGen.StartRoomCheck` a stable hook point across tModLoader versions?
3. **Ghost mode**: When player dies in hardcore and becomes ghost, should fog rules still apply?
4. **Binoculars/scopes**: Items that extend view range - do they update `Main.Map` for distant tiles?

---

## Alternative: Aggressive Approach

Instead of just blocking the query, we could:

1. Allow the query
2. Return a FAKE result for unexplored areas

This would make the exploit actively misleading:

```csharp
if (!IsTileExplored(x, y)) {
    // 50% chance "not valid", 50% chance "missing [random furniture]"
    // Never returns "suitable" for unexplored
    return GenerateFakeResult();
}
```

**Pros:** Punishes exploit attempts, doesn't reveal the mod's presence  
**Cons:** Confusing if player legitimately clicks wrong spot, may cause bug reports

Probably not worth the complexity. Simple blocking is cleaner.

---